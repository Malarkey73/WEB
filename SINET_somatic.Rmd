---
title: "SINET_somatic"
author: "Stephen Henderson"
date: "7/21/2017"
output: html_document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Somatic Variants in SINET 

The VARSCAN pipeline was largely adapted from the  

This section merged together the files from the 

```{r dataparsing, message=FALSE, warning=FALSE, eval =FALSE}

library(tidyverse)
library(stringr)

PATIENTVARSOM<- list.files(pattern="_T.snp.Somatic") %>% 
  sapply(read_tsv, simplify=FALSE) %>%
  bind_rows(.id = "id") %>%
  mutate(id = str_replace(id, "_T.snp.Somatic", "")) %>%
  mutate(normal_var_freq = str_replace(normal_var_freq, "%", ""), 
         tumor_var_freq= str_replace(tumor_var_freq, "%", "")) %>%
  mutate(normal_var_freq = as.numeric(normal_var_freq), 
         tumor_var_freq = as.numeric(tumor_var_freq))

PATIENTVARSOM.GR<- GRanges(seqnames = Rle(PATIENTVARSOM$chrom),
                            ranges = IRanges(PATIENTVARSOM$position, width=1)

)

mcols(PATIENTVARSOM.GR)$REF <- DNAStringSet(PATIENTVARSOM$ref)
mcols(PATIENTVARSOM.GR)$ALT <- DNAStringSetList(as.list(PATIENTVARSOM$var))
mcols(PATIENTVARSOM.GR)$PATIENT <- PATIENTVARSOM$id




REGIONVARSOM<- list.files(pattern="R*T.snp.Somatic") %>% 
  sapply(read_tsv, simplify=FALSE) %>%
  bind_rows(.id = "id") %>%
  mutate(id = str_replace(id, ".snp.Somatic", "")) %>%
  separate(id, into = c("patient_id", "region_id"), sep ="_") %>%
  mutate(normal_var_freq= str_replace(normal_var_freq, "%", ""), 
         tumor_var_freq= str_replace(tumor_var_freq, "%", "")) %>%
  mutate(normal_var_freq = as.numeric(normal_var_freq), 
         tumor_var_freq = as.numeric(tumor_var_freq))
         
REGIONVARSOM.GR<- GRanges(seqnames = Rle(REGIONVARSOM$chrom),
                            ranges = IRanges(REGIONVARSOM$position, width=1)

)

mcols(REGIONVARSOM.GR)$REF <- DNAStringSet(REGIONVARSOM$ref)
mcols(REGIONVARSOM.GR)$ALT <- DNAStringSetList(as.list(REGIONVARSOM$var))
mcols(REGIONVARSOM.GR)$PATIENTID <- REGIONVARSOM$patient_id
mcols(REGIONVARSOM.GR)$REGIONID <- REGIONVARSOM$region_id

####

PATIENTVARSOM %<>% 
  group_by(chrom, position) %>% 
  summarise(N = n(), 
            normal_reads1 = mean(normal_reads1), 
            normal_reads2 = mean(normal_reads2), 
            normal_var_freq = mean(normal_var_freq), 
            tumor_var_freq = mean(tumor_var_freq), 
            tumor_reads1 = mean(tumor_reads1), 
            tumor_reads2 =  mean(tumor_reads2))  %>% 
  arrange(desc(N), 
          desc(tumor_reads2 - normal_reads2))

REGIONVARSOM %<>% 
  group_by(chrom, position) %>% 
  summarise(N = n(), 
            normal_reads1 = mean(normal_reads1), 
            normal_reads2 = mean(normal_reads2), 
            normal_var_freq = mean(normal_var_freq), 
            tumor_var_freq = mean(tumor_var_freq), 
            tumor_reads1 = mean(tumor_reads1), 
            tumor_reads2 = mean(tumor_reads2))  %>% 
  arrange(desc(N), 
          desc(tumor_reads2 - normal_reads2))
          
  write_tsv(REGIONVARSOM, "Region.Somatic.snp.tsv")
  write_tsv(PATIENTVARSOM, "Patient.Somatic.snp.tsv")

```


```{r dataload, message=FALSE, warning=FALSE}
library(tidyverse)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
REGIONVARSOM <- read_tsv("Region.Somatic.snp.tsv")
PATIENTVARSOM <- read_tsv("Patient.Somatic.snp.tsv")
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene

```

Plot the Variant frequency vs the Read Depth.

```{r plotVarFrqDepth, message =FALSE, warning= FALSE}

library(ggplot2)
library(gganimate)
gg<- ggplot(ANIM, aes(x = tumor_var_freq, y= tumor_reads1 + tumor_reads2, frame= chrom)) +
  geom_point() +
  ylab("Tumour Depth") +
  xlab("Tumour Variant Frequency") +
  geom_hline(aes(yintercept=30), color="black", linetype="dashed") +
  theme_bw()

#gg
gganimate(gg)

```


### Interactive

Let's try interactive Shiny...


```{r shiny, cache= FALSE, echo = FALSE}

#numericInput("inp_tumor_var_freq", "Min Tumour Variant Frequency?", 15)
#numericInput("inp_tumor_reads", "Min Tumour Read Depth?", 30)

#renderTable({
#  filter(SHINY, 
#  tumor_var_freq > input$inp_tumor_var_freq,
#  (tumor_reads1 + tumor_reads2) > input$inp_tumor_reads
#  ) %>%
#    arrange(desc(tumor_reads2))
#})
```
