---
title: "SINET_somatic"
author: "Stephen Henderson"
date: "7/21/2017"
output: html_document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

### Somatic Variants in SINET 

The VARSCAN pipeline was largely adapted from the  

This section merged together the files from the 

```{r dataparsing, message=FALSE, warning=FALSE, eval =FALSE}

library(tidyverse)
library(stringr)
library(Biostrings)

PATIENTVARSOM <- list.files(pattern="_T.snp.Somatic") %>% 
  sapply(read_tsv, simplify=FALSE) %>%
  bind_rows(.id = "id") %>%
  mutate(id = str_replace(id, "_T.snp.Somatic", "")) %>%
  mutate(normal_var_freq = str_replace(normal_var_freq, "%", ""), 
         tumor_var_freq= str_replace(tumor_var_freq, "%", "")) %>%
  mutate(normal_var_freq = as.numeric(normal_var_freq), 
         tumor_var_freq = as.numeric(tumor_var_freq))

PATIENTVARSOM.GR<- GRanges(seqnames = Rle(PATIENTVARSOM$chrom),
                            ranges = IRanges(PATIENTVARSOM$position, width=1))

mcols(PATIENTVARSOM.GR)$REF <- DNAStringSet(PATIENTVARSOM$ref)
mcols(PATIENTVARSOM.GR)$ALT <- DNAStringSetList(as.list(PATIENTVARSOM$var))
mcols(PATIENTVARSOM.GR)$PATIENT <- PATIENTVARSOM$id

library(TxDb.Hsapiens.UCSC.hg38.knownGene)
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene
library(org.Hs.eg.db)
e2s = toTable(org.Hs.egSYMBOL) 

PATIENTVARSOM.ANNO <- locateVariants(PATIENTVARSOM.GR, txdb, CodingVariants()) %>%
  unique() %>%
  as.data.frame() %>%
  as.tbl()
  
PATIENTVARSOM <-  PATIENTVARSOM.ANNO %>% 
  dplyr::select(chrom = seqnames, position = start, EntrezID = GENEID, Variant_Type = LOCATION, Variant_Location = LOCSTART) %>%
  right_join(PATIENTVARSOM) %>%
  mutate(Symbol = e2s$symbol[match(EntrezID, e2s$gene_id)])

REGIONVARSOM<- list.files(pattern="R*T.snp.Somatic") %>% 
  sapply(read_tsv, simplify=FALSE) %>%
  bind_rows(.id = "id") %>%
  mutate(id = str_replace(id, ".snp.Somatic", "")) %>%
  separate(id, into = c("patient_id", "region_id"), sep ="_") %>%
  mutate(normal_var_freq= str_replace(normal_var_freq, "%", ""), 
         tumor_var_freq= str_replace(tumor_var_freq, "%", "")) %>%
  mutate(normal_var_freq = as.numeric(normal_var_freq), 
         tumor_var_freq = as.numeric(tumor_var_freq))
         
REGIONVARSOM.GR<- GRanges(seqnames = Rle(REGIONVARSOM$chrom),
                            ranges = IRanges(REGIONVARSOM$position, width=1)

)

mcols(REGIONVARSOM.GR)$REF <- DNAStringSet(REGIONVARSOM$ref)
mcols(REGIONVARSOM.GR)$ALT <- DNAStringSetList(as.list(REGIONVARSOM$var))
mcols(REGIONVARSOM.GR)$PATIENT <- REGIONVARSOM$patient_id
mcols(REGIONVARSOM.GR)$REGION <- REGIONVARSOM$region_id

REGIONVARSOM.ANNO <- locateVariants(REGIONVARSOM.GR, txdb, CodingVariants()) %>%
  unique() %>%
  as.data.frame() %>%
  as.tbl()
  

REGIONVARSOM <- REGIONVARSOM.ANNO %>% 
  dplyr::select(chrom = seqnames, position = start, EntrezID = GENEID, Variant_Type = LOCATION, Variant_Location = LOCSTART) %>%
  right_join(REGIONVARSOM) %>%
  mutate(Symbol = e2s$symbol[match(EntrezID, e2s$gene_id)])

write_tsv(REGIONVARSOM, "Region.Somatic.snp.tsv")
write_tsv(PATIENTVARSOM, "Patient.Somatic.snp.tsv")
rm(txdb,e2s, PATIENTVARSOM.GR, REGIONVARSOM.GR, REGIONVARSOM.ANNO, PATIENTVARSOM.ANNO)
```


```{r dataload, message=FALSE, warning=FALSE}
library(tidyverse)
REGIONVARSOM <- read_tsv("Region.Somatic.snp.tsv")
PATIENTVARSOM <- read_tsv("Patient.Somatic.snp.tsv")

```

Plot the Variant frequency vs the Read Depth.

```{r plotVarFrqDepth, message =FALSE, warning= FALSE}

library(ggplot2)
library(gganimate)
gg<- ggplot(REGIONVARSOM, aes(x = tumor_var_freq, y= tumor_reads1 + tumor_reads2, frame= chrom)) +
  geom_point() +
  ylab("Tumour Depth") +
  xlab("Tumour Variant Frequency") +
  geom_hline(aes(yintercept=30), color="black", linetype="dashed") +
  theme_bw()

#gg
gganimate(gg)


 REGIONVARSOM %>% dplyr::select(1:11, 14:15, Symbol, tumor_var_freq) %>% arrange(desc(tumor_var_freq)) %>% filter(tumor_reads2 > 13)
 
```

